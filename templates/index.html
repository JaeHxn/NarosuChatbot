<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›ï¸ ChatMall - AI ì‡¼í•‘ ì–´ì‹œìŠ¤í„´íŠ¸</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center;
            padding: 20px; position: relative; color: #334155;
        }
        body::before {
            content: '';
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(120,119,198,0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,119,198,0.03) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120,200,255,0.03) 0%, transparent 50%);
            z-index: -1; pointer-events: none;
        }
        .chat-container {
            width: 100%; max-width: 900px; height: 85vh;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08), 0 0 0 1px rgba(255,255,255,0.1);
            display: flex; flex-direction: column; overflow: hidden; position: relative;
            border: 1px solid rgba(226,232,240,0.8);
        }
        .chat-header {
            background: linear-gradient(135deg,#ffffff 0%,#f8fafc 100%);
            color: #475569; text-align: center; padding: 25px; font-size: 24px;
            font-weight: 600; border-radius: 20px 20px 0 0;
            border-bottom: 1px solid rgba(226,232,240,0.6);
        }
        .chat-header i {
            margin-right: 12px; font-size: 26px; color: #3b82f6;
            animation: bounce 3s infinite;
        }
        @keyframes bounce {
            0%,20%,50%,80%,100%{transform:translateY(0);}
            40%{transform:translateY(-5px);}
            60%{transform:translateY(-3px);}
        }
        .chat-messages {
            flex:1; padding:25px; overflow-y:auto; background:#f8fafc;
            display:flex; flex-direction:column; gap:20px;
        }
        .chat-messages::-webkit-scrollbar { width:6px; }
        .chat-messages::-webkit-scrollbar-track { background:rgba(226,232,240,0.3); border-radius:10px; }
        .chat-messages::-webkit-scrollbar-thumb { background:linear-gradient(135deg,#cbd5e1,#94a3b8); border-radius:10px; }
        .message {
            padding:18px 22px; border-radius:16px; max-width:80%; font-size:15px;
            line-height:1.6; word-wrap:break-word; position:relative;
            animation:messageSlide 0.4s ease-out;
        }
        @keyframes messageSlide {
            from{opacity:0;transform:translateY(15px);} to{opacity:1;transform:translateY(0);}
        }
        .user {
            align-self:flex-end;
            background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);
            color:white; box-shadow:0 4px 20px rgba(59,130,246,0.2);
        }
        .bot {
            align-self:flex-start; background:#ffffff; color:#374151;
            border:1px solid rgba(226,232,240,0.8); box-shadow:0 2px 12px rgba(0,0,0,0.04);
        }

        /* ====== Slider Styles ====== */
        .slider-container {
          position: relative; width: 100%; height: 600px;
          overflow: hidden; margin-top: 20px; height: auto;
        }
        .slides-wrapper {
          display: flex; gap: 20px; transition: transform 0.3s ease;
        }
        .slider-btn {
          position: absolute; top: 50%; transform: translateY(-50%);
          background: rgba(0,0,0,0.3); border: none;
          color: white; font-size: 24px; width: 36px; height: 36px;
          border-radius: 50%; cursor: pointer; z-index: 10;
        }
        .slider-btn.prev { left: 10px; }
        .slider-btn.next { right: 10px; }
        /* ============================= */

        .product-card {
            background:#ffffff; border:1px solid rgba(226,232,240,0.6);
            border-radius:16px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.04);
            flex: 0 0 260px;
            display: flex;
            flex-direction: column;
        }
        .product-image-container {
            width:100%; height:160px; margin-bottom:12px;
            border-radius:12px; overflow:hidden;
            background:linear-gradient(45deg,#f1f5f9,#e2e8f0);
        }
        .product-image {
            width:100%; height:100%; object-fit:cover;
            transition:transform 0.3s ease;
        }
        .product-image:hover { transform:scale(1.05); }
        .product-image-placeholder {
            display:flex; align-items:center; justify-content:center;
            background:linear-gradient(45deg,#f8fafc,#e2e8f0);
            color:#94a3b8; font-size:36px;
        }
        .product-title {
            font-weight:600; font-size:14px; color:#1e293b;
            margin-bottom:8px; line-height:1.4;
        }
        .badge {
            padding:4px 8px; border-radius:12px; font-size:11px;
            font-weight:500; display:inline-block;
        }
        .badge-category {
            background:linear-gradient(135deg,#dbeafe,#bfdbfe);
            color:#1e40af; margin-right:4px;
        }
        .badge-shipping {
            background:linear-gradient(135deg,#dcfce7,#bbf7d0);
            color:#166534;
        }
        .product-price {
            font-size:16px; font-weight:700; color:#dc2626;
            margin:8px 0; text-align:center;
        }
        .product-info {
            font-size:12px; color:#64748b; margin:4px 0;
            display:flex; align-items:center;
        }
        .product-info i { margin-right:4px; color:#3b82f6; }
        .product-link {
            display:block; width:100%; text-decoration:none;
            text-align:center; padding:8px;
            background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);
            color:white; border-radius:12px; margin-top:12px;
            margin-top: auto;
        }
        .product-link:hover {
            transform:translateY(-2px);
            box-shadow:0 4px 16px rgba(59,130,246,0.3);
        }

        .chat-input {
            display:flex; border-top:1px solid rgba(226,232,240,0.6);
            padding:20px; background:#ffffff; gap:12px;
        }
        .input-container { flex:1; position:relative; }
        .input-container i {
            position:absolute; left:16px; top:50%;
            transform:translateY(-50%); color:#94a3b8;
        }
        .chat-input input {
            width:100%; padding:12px 16px 12px 45px;
            border:1px solid rgba(226,232,240,0.8);
            border-radius:16px; outline:none; background:#f8fafc;
        }
        .btn-primary {
            background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);
            color:white; border:none; border-radius:16px; padding:12px 20px;
        }
        .btn-secondary {
            background:linear-gradient(135deg,#e2e8f0 0%,#cbd5e1 100%);
            color:#475569; border:none; border-radius:16px; padding:12px 20px;
        }
        .btn-primary:disabled,
        .btn-secondary:disabled {
            background:#f1f5f9; color:#94a3b8; cursor:not-allowed;
        }
        .loading-spinner { display:none; margin:25px auto; text-align:center; }
        .spinner {
            width:40px; height:40px; border:3px solid rgba(59,130,246,0.1);
            border-top:3px solid #3b82f6; border-radius:50%;
            animation:spin 1s linear infinite; margin:0 auto 12px;
        }
        .loading-text {
            color:#64748b; font-weight:500; font-size:14px;
        }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        .alert { border-radius:12px; padding:16px; margin:12px 0; border:1px solid; }
        .alert-error {
            background:linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%);
            color:#dc2626; border-color:rgba(220,38,38,0.2);
        }
        .alert-success {
            background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);
            color:#166534; border-color:rgba(22,101,52,0.2);
        }
        .welcome-message {
            text-align:center; padding:30px 20px;
            background:linear-gradient(135deg,#ffffff 0%,#f8fafc 100%);
            border-radius:16px; border:1px solid rgba(226,232,240,0.6);
        }
        .welcome-message i {
            font-size:40px; color:#3b82f6; margin-bottom:16px;
            animation:pulse 2s infinite;
        }
        @keyframes pulse {
            0%,100%{transform:scale(1);opacity:1;} 50%{transform:scale(1.05);opacity:0.8;}
        }
        .search-suggestions {
            display:flex; flex-wrap:wrap; gap:8px; margin-top:16px;
            justify-content:center;
        }
        .suggestion-tag {
            padding:8px 14px; background:linear-gradient(135deg,#dbeafe,#bfdbfe);
            color:#1e40af; border:1px solid rgba(30,64,175,0.1);
            border-radius:16px; font-size:13px; cursor:pointer; transition:all 0.3s ease;
        }
        .suggestion-tag:hover {
            transform:translateY(-2px);
            box-shadow:0 4px 12px rgba(59,130,246,0.15);
            background:linear-gradient(135deg,#bfdbfe,#93c5fd);
        }
        @media(max-width:768px){
            body{padding:10px;}
            .chat-container{width:100%;height:95vh;border-radius:16px;}
        }
        @media(max-width:480px){
            .chat-header{font-size:18px;padding:16px;}
        }
        /* í˜ì´ë“œ íŠ¸ëœì§€ì…˜ìš© */
        .fade {
          transition: opacity 0.5s ease;
        }
        .hidden {
          opacity: 0;
        }
        .visible {
          opacity: 1;
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">
            <i class="fas fa-robot"></i> ChatMall AI ì‡¼í•‘ ì–´ì‹œìŠ¤í„´íŠ¸
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message bot">
                <div class="welcome-message">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h3>
                    <p>ChatMallì˜ ìŠ¤ë§ˆíŠ¸ AI ì‡¼í•‘ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤!</p>
                    <p>ì›í•˜ëŠ” ìƒí’ˆì„ ìì—°ì–´ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´:</p>
                    <div class="search-suggestions">
                        <span class="suggestion-tag" onclick="searchSuggestion('ë‚¨ì„± í–¥ìˆ˜')">
                            <i class="fas fa-spray-can"></i> ë‚¨ì„± í–¥ìˆ˜
                        </span>
                        <span class="suggestion-tag" onclick="searchSuggestion('ì—¬ì„± ê°€ë°©')">
                            <i class="fas fa-bag-shopping"></i> ì—¬ì„± ê°€ë°©
                        </span>
                        <span class="suggestion-tag" onclick="searchSuggestion('ìŠ¤ë§ˆíŠ¸í°')">
                            <i class="fas fa-mobile-alt"></i> ìŠ¤ë§ˆíŠ¸í°
                        </span>
                        <span class="suggestion-tag" onclick="searchSuggestion('ìš´ë™í™”')">
                            <i class="fas fa-running"></i> ìš´ë™í™”
                        </span>
                        <span class="suggestion-tag" onclick="searchSuggestion('í™”ì¥í’ˆ')">
                            <i class="fas fa-palette"></i> í™”ì¥í’ˆ
                        </span>
                        <span class="suggestion-tag" onclick="searchSuggestion('íŒ¨ì…˜ì˜ë¥˜')">
                            <i class="fas fa-tshirt"></i> íŒ¨ì…˜ì˜ë¥˜
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading-spinner" class="loading-spinner">
            <div class="spinner"></div>
            <div class="loading-text">
                <i class="fas fa-search"></i> AIê°€ ìµœì ì˜ ìƒí’ˆì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...
            </div>
        </div>

        <div class="chat-input">
            <div class="input-container">
                <i class="fas fa-search"></i>
                <input
                    type="text"
                    id="user-input"
                    placeholder="ì–´ë–¤ ìƒí’ˆì„ ì°¾ê³  ê³„ì‹œë‚˜ìš”? ìì—°ìŠ¤ëŸ½ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”!"
                    onkeydown="handleKeyPress(event)"
                >
            </div>
            <button id="send-btn" class="btn-primary" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i> ê²€ìƒ‰
            </button>
            <button id="reset-btn" class="btn-secondary" onclick="resetChat()">
                <i class="fas fa-redo"></i> ë¦¬ì…‹
            </button>
        </div>
    </div>

    <script>
        function showWelcome() {
            const box = document.getElementById('chat-messages');
            box.innerHTML = `
              <div class="message bot">
                <div class="welcome-message">
                  <i class="fas fa-shopping-cart"></i>
                  <h3>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</h3>
                  <p>ChatMallì˜ ìŠ¤ë§ˆíŠ¸ AI ì‡¼í•‘ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤!</p>
                  <p>ì›í•˜ëŠ” ìƒí’ˆì„ ìì—°ì–´ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì˜ˆë¥¼ ë“¤ì–´:</p>
                  <div class="search-suggestions">
                    <span class="suggestion-tag" onclick="searchSuggestion('ë‚¨ì„± í–¥ìˆ˜')">
                      <i class="fas fa-spray-can"></i> ë‚¨ì„± í–¥ìˆ˜
                    </span>
                    <span class="suggestion-tag" onclick="searchSuggestion('ì—¬ì„± ê°€ë°©')">
                      <i class="fas fa-bag-shopping"></i> ì—¬ì„± ê°€ë°©
                    </span>
                    <span class="suggestion-tag" onclick="searchSuggestion('ìŠ¤ë§ˆíŠ¸í°')">
                      <i class="fas fa-mobile-alt"></i> ìŠ¤ë§ˆíŠ¸í°
                    </span>
                    <span class="suggestion-tag" onclick="searchSuggestion('ìš´ë™í™”')">
                      <i class="fas fa-running"></i> ìš´ë™í™”
                    </span>
                    <span class="suggestion-tag" onclick="searchSuggestion('í™”ì¥í’ˆ')">
                      <i class="fas fa-palette"></i> í™”ì¥í’ˆ
                    </span>
                    <span class="suggestion-tag" onclick="searchSuggestion('íŒ¨ì…˜ì˜ë¥˜')">
                      <i class="fas fa-tshirt"></i> íŒ¨ì…˜ì˜ë¥˜
                    </span>
                  </div>
                </div>
              </div>
            `;
          }

        
        const sessionId = 'session_' + Math.random().toString(36).substr(2,9);
        let isLoading = false;
        const sliders = {};

        function initSlider(id,count){
            sliders[id]={idx:0,count};
        }
        function updateSlider(id){
            const wr=document.querySelector(`#${id} .slides-wrapper`);
            const {idx} = sliders[id];
            const cardW = wr.children[0].offsetWidth + 20;
            wr.style.transform = `translateX(${-idx*cardW}px)`;
        }
        function prevSlide(id){ if(!sliders[id])return; sliders[id].idx=Math.max(0,sliders[id].idx-1); updateSlider(id); }
        function nextSlide(id){ if(!sliders[id])return; sliders[id].idx=Math.min(sliders[id].count-1,sliders[id].idx+1); updateSlider(id); }

        function handleKeyPress(e){
            if(e.key==='Enter' && !isLoading) sendMessage();
        }
        function searchSuggestion(q){
            document.getElementById('user-input').value=q;
            sendMessage();
        }
        function setLoading(l){
            isLoading=l;
            document.getElementById('send-btn').disabled=l;
            document.getElementById('reset-btn').disabled=l;
            document.getElementById('user-input').disabled=l;
            document.getElementById('loading-spinner').style.display=l?'block':'none';
        }
        function addMessage(html,isUser=false){
            const box=document.getElementById('chat-messages');
            const div=document.createElement('div');
            div.className=`message ${isUser?'user':'bot'}`;
            div.innerHTML=html;
            box.appendChild(div);
            setTimeout(()=>box.scrollTop=box.scrollHeight,100);
        }
        function formatPrice(p){
            const n=Number(p)||0; return n.toLocaleString('ko-KR');
        }
        function createProductCard(prod){
            const price=formatPrice(prod.ê°€ê²©);
            const free=prod.ë°°ì†¡ë¹„==0?
              '<span class="badge badge-shipping"><i class="fas fa-truck"></i> ë¬´ë£Œë°°ì†¡</span>':'';
            return `
            <div class="product-card">
              <div class="product-image-container">
                ${prod.ì´ë¯¸ì§€&&prod.ì´ë¯¸ì§€!=='ì´ë¯¸ì§€ ì—†ìŒ'
                  ? `<img src="${prod.ì´ë¯¸ì§€}" class="product-image"
                        onerror="this.parentElement.innerHTML=
                          '<div class=\'product-image-placeholder\'>
                              <i class=\'fas fa-image\'></i>
                           </div>'">`
                  : `<div class="product-image-placeholder"><i class="fas fa-image"></i></div>`
                }
              </div>
              <div class="product-title">${prod.ì œëª©||'ì œëª© ì—†ìŒ'}</div>
              <div class="badge badge-category"><i class="fas fa-tags"></i> ${prod.ì¹´í…Œê³ ë¦¬||'ê¸°íƒ€'}</div>
              ${free}
              <div class="product-info"><i class="fas fa-won-sign"></i> ${price}ì›</div>
              <div class="product-info"><i class="fas fa-truck"></i> ë°°ì†¡ë¹„: ${formatPrice(prod.ë°°ì†¡ë¹„)}ì›</div>
              <div class="product-info"><i class="fas fa-barcode"></i> ìƒí’ˆì½”ë“œ: ${prod.ìƒí’ˆì½”ë“œ}</div>
              <div class="product-info"><i class="fas fa-globe-asia"></i> ì›ì‚°ì§€: ${prod.ì›ì‚°ì§€}</div>
              <div class="product-info"><i class="fas fa-cogs"></i> ì˜µì…˜: ${prod.ì˜µì…˜}</div>
              <div class="product-info"><i class="fas fa-boxes"></i> ìµœëŒ€êµ¬ë§¤ìˆ˜ëŸ‰: ${prod.ìµœëŒ€êµ¬ë§¤ìˆ˜ëŸ‰}ê°œ</div>
              <a href="${prod.ìƒí’ˆë§í¬}" target="_blank" class="product-link">
                <i class="fas fa-external-link-alt"></i> ìƒí’ˆ ìƒì„¸ë³´ê¸°
              </a>
            </div>`;
        }

        async function sendMessage(){
            const inp=document.getElementById('user-input');
            const q=inp.value.trim();
            if(!q||isLoading) return;
            addMessage(`<i class="fas fa-user"></i> ${q}`,true);
            inp.value=''; setLoading(true);
            try{
                const res=await fetch('/debug-search',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({query:q,session_id:sessionId})
                });
                const data=await res.json();
                if(data.combined_message_text){
                    addMessage(`<i class="fas fa-robot"></i> ${data.combined_message_text}`);
                }
                if(Array.isArray(data.results)&&data.results.length){
                    const sid=`slider-${Date.now()}`;
                    const slides=data.results.map(p=>createProductCard(p)).join('');
                    const html=`
                    <div class="slider-container" id="${sid}">
                      <button class="slider-btn prev" onclick="prevSlide('${sid}')">&lt;</button>
                      <div class="slides-wrapper">${slides}</div>
                      <button class="slider-btn next" onclick="nextSlide('${sid}')">&gt;</button>
                    </div>`;
                    addMessage(html,false);
                    initSlider(sid,data.results.length);
                } else {
                    addMessage(`<div class="alert alert-error"><i class="fas fa-exclamation-triangle"></i> ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);
                }
            } catch(e){
                addMessage(`<div class="alert alert-error"><i class="fas fa-exclamation-circle"></i> ì„œë²„ ì—°ê²° ì˜¤ë¥˜</div>`);
            } finally {
                setLoading(false);
            }
        }
        
        
        // íƒ€ì´ë¨¸ì™€ ì½œë°±ì„ ìœ„ë¡œ ë¶„ë¦¬
        const RESET_DELAY = 3000;
        function onResetComplete() {
            showWelcome();
            const box = document.getElementById('chat-messages');
            box.classList.remove('hidden');
            box.classList.add('visible');
        }
        
        async function resetChat(){
          if (isLoading) return;
          setLoading(true);
          try {
            await fetch('/debug-search', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ query: 'reset', session_id: sessionId })
            });
                      
            //  í˜ì´ë“œ ì•„ì›ƒ
            const box = document.getElementById('chat-messages');
            box.classList.add('fade', 'hidden');

              
            //  íƒ€ì´ë¨¸ëŠ” ë°–ì—ì„œ ì •ì˜ëœ onResetComplete í˜¸ì¶œ
            setTimeout(onResetComplete, RESET_DELAY);

              
        
          } catch (e) {
            addMessage(`
              <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i> ë¦¬ì…‹ ì˜¤ë¥˜
              </div>
            `);
          } finally {
            setLoading(false);
          }
        }

        window.addEventListener('load', () => {
            showWelcome();
            document.getElementById('user-input').focus();
        });
    </script>
</body>

</html>
